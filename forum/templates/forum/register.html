{% extends 'forum/base.html' %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'forum/css/course-selector.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/register.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/asset.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="main-container">
    <h1 class="page-title">WolfKey</h1>

    <div class="progress-container">
        <div class="step-item">
            <div class="step-circle active" data-step="0">1</div>
            <div class="step-label active">User Type</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="1">2</div>
            <div class="step-label">Personal Info</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="2">3</div>
            <div class="step-label">Course Experience</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="3">4</div>
            <div class="step-label">Schedule</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="4">5</div>
            <div class="step-label">Complete</div>
        </div>
    </div>

    <div class="card">
        <form id="onboardingForm" method="post" action="{% url 'register' %}">
            {% csrf_token %}
            
            <!-- Step 0: User Type Selection -->
            <div class="form-step active" data-step="0">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>Welcome to WolfKey!</h3>
                    <p>Are you a student or a teacher?</p>
                </div>
                
                <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="user-type-card" data-user-type="student">
                                <div class="user-type-icon">
                                    <i class="fas fa-user-graduate fa-3x"></i>
                                </div>
                                <h5>Student</h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="user-type-card" data-user-type="teacher">
                                <div class="user-type-icon">
                                    <i class="fas fa-chalkboard-teacher fa-3x"></i>
                                </div>
                                <h5>Teacher</h5>
                            </div>
                        </div>
                    </div>
                    {{ form.user_type }}
                    <div class="error-message" id="error-user_type"></div>
                </div>

                <div class="continue-btn">
                    <button type="button" class="btn btn-primary" id="nextBtn0" disabled>Continue <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <!-- Step 1: Personal Information -->
            <div class="form-step" data-step="1">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <p>Let's start with some information</p>
                </div>
                
                <div class="row">
                    <div class="col-6 mb-3">
                        {{ form.first_name }}
                        {% if form.first_name.help_text %}
                            <small class="help-text">{{ form.first_name.help_text }}</small>
                        {% endif %}
                        <div class="error-message" id="error-first_name"></div>
                    </div>
                    <div class="col-6 mb-3">
                        {{ form.last_name }}
                        {% if form.last_name.help_text %}
                            <small class="help-text">{{ form.last_name.help_text }}</small>
                        {% endif %}
                        <div class="error-message" id="error-last_name"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ form.school_email }}
                    {% if form.school_email.help_text %}
                        <small class="help-text">{{ form.school_email.help_text }}</small>
                    {% endif %}
                    <div class="error-message" id="error-school_email"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.personal_email }}
                    {% if form.personal_email.help_text %}
                        <small class="help-text">{{ form.personal_email.help_text |safe }}</small>
                    {% endif %}
                    <div class="error-message" id="error-personal_email"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.phone_number }}
                    {% if form.phone_number.help_text %}
                        <small class="help-text">{{ form.phone_number.help_text | safe}}</small>
                    {% endif %}
                    <div class="error-message" id="error-phone_number"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.password1 }}
                    {% if form.password1.help_text %}
                        <small class="help-text">{{ form.password1.help_text }}</small>
                    {% endif %}
                    <div class="error-message" id="error-password1"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.password2 }}
                    {% if form.password2.help_text %}
                        <small class="help-text">{{ form.password2.help_text }}</small>
                    {% endif %} 
                    <div class="error-message" id="error-password2"></div>
                </div>

                <div class="mb-3">
                    {{ form.grade_level }}
                    {% if form.grade_level.help_text %}
                        <small class="help-text">{{ form.grade_level.help_text }}</small>
                    {% endif %}
                    <div class="error-message" id="error-grade_level"></div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn1">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn1">Continue <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <!-- Step 2: Course Experience -->
            <div class="form-step" data-step="2">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>Course Experience</h3>
                </div>

                <h6 class="mb-0 text-warning"><i class="fas fa-hand-paper"></i> Courses You'd Like Help With</h6>
                <div class="card-body">
                    <p class="small text-muted">Select at least 3 courses where you'd appreciate help</p>
                    <div id="helpCoursesSelector"></div>
                    <input type="hidden" name="help_courses" id="help_courses_input">
                    <div class="mt-2">
                        <small id="helpCoursesCount" class="text-muted">0 courses selected (minimum 3)</small>
                    </div>

                </div>
            
                <h6 class="mb-0 text-success"><i class="fas fa-star"></i> Courses You're Proficient In</h6>
                <div class="card-body">
                    <p class="small text-muted">Select at least 3 courses where you excel and could help others</p>
                    <div id="experienceCoursesSelector"></div>
                    <input type="hidden" name="experience_courses" id="experience_courses_input">
                    <div class="mt-2">
                        <small id="experienceCoursesCount" class="text-muted">0 courses selected (minimum 3)</small>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn2">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn2Continue" disabled>Continue <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <!-- Step 3: Schedule & Preferences -->
            <div class="form-step" data-step="3">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>Your Schedule & Preferences</h3>
                    <p class="text-muted">Fill in your course schedule and set your privacy preferences (optional)</p>
                </div>

                <!-- Schedule content -->
                <div id="scheduleContent">
                    <h6 class="mb-3"><i class="fas fa-calendar"></i> Course Schedule</h6>
                    <form id="scheduleForm">
                        {% include 'forum/partials/schedule_block.html' %}
                    </form>
                </div>

                <!-- Privacy Preferences -->
                <h6 class="mb-3"><i class="fas fa-user-shield"></i> Privacy Preferences</h6>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="allow_schedule_comparison" id="id_allow_schedule_comparison" checked>
                    <label class="form-check-label" for="id_allow_schedule_comparison">
                        <strong>Allow schedule comparison</strong>
                        <br>
                        <small class="text-muted">Turn this on to let others see your schedule â€” you won't be able to compare schedules if it's off.</small>
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="allow_grade_updates" id="id_allow_grade_updates" checked>
                    <label class="form-check-label" for="id_allow_grade_updates">
                        <strong>Enable grade notifications</strong>
                        <br>
                        <small class="text-muted">Receive automatic notifications when assignments are graded.</small>
                    </label>
                </div>

                <div class="d-flex justify-content-between mt-4" id="scheduleNavigation">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn3">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn3">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Final Step: Completion -->
            <div class="form-step" data-step="4">
                <div class="text-center py-5">
                    <div class="user-icon">
                        <div class="icon" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <h3 class="mb-4 text-success">Welcome to WolfKey! ðŸŽ‰</h3>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-rocket"></i> Enter WolfKey
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% load static %}
<script type="module">
    import { CourseSelector } from '{% static "forum/js/course-selector.js" %}';
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('onboardingForm');
        console.log('Form found:', form ? 'Yes' : 'No');
        
        const steps = document.querySelectorAll('.form-step');
        const stepCircles = document.querySelectorAll('.step-circle');
        const stepLabels = document.querySelectorAll('.step-label');
        
        let currentStep = 0;
        let courseSelectors = {};
        let currentHelpCourses = [];
        let currentExperienceCourses = [];

        // Prefill grade if server provided a saved value
        const savedGradeLevel = '{{ saved_grade_level|default:"" }}';
        if (savedGradeLevel) {
            const gradeField = document.getElementById('id_grade_level');
            if (gradeField) gradeField.value = savedGradeLevel;
        }

        // ===============================================
        // USER TYPE SELECTION (STEP 0)
        // ===============================================
        
        // Handle user type card selection
        const userTypeCards = document.querySelectorAll('.user-type-card');
        const userTypeInput = document.getElementById('id_user_type');
        const nextBtn0 = document.getElementById('nextBtn0');
        
        userTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove active class from all cards
                userTypeCards.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked card
                this.classList.add('active');
                
                // Set the hidden select value
                const userType = this.getAttribute('data-user-type');
                if (userTypeInput) {
                    userTypeInput.value = userType;
                }
                
                // Enable next button
                if (nextBtn0) {
                    nextBtn0.disabled = false;
                }
            });
        });
        
        // ===============================================
        // UTILITY FUNCTIONS
        // ===============================================
        
        // Update step UI
        function updateSteps() {
            steps.forEach(step => {
                step.classList.remove('active');
                step.style.display = 'none';
            });
            stepCircles.forEach(circle => circle.classList.remove('active'));
            stepLabels.forEach(label => label.classList.remove('active'));
            
            // Show current step
            const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`) || 
                                      document.querySelector(`.form-step[data-step="complete"]`);
            if (currentStepElement) {
                currentStepElement.classList.add('active');
                currentStepElement.style.display = 'block';
            }
            
            // Update progress circles and bar
            const progressContainer = document.querySelector('.progress-container');
            // Add 1 to currentStep for display purposes (0 -> 1, 1 -> 2, etc.)
            const stepNumber = currentStep + 1;
            progressContainer.setAttribute('data-progress', stepNumber);
            
            stepCircles.forEach((circle, index) => {
                if (index <= currentStep) {
                    circle.classList.add('active');
                    circle.parentElement.querySelector('.step-label').classList.add('active');
                }
            });
        }

        // Show validation error
        function showError(fieldName, message) {
            const errorElement = document.getElementById(`error-${fieldName}`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                const input = document.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.classList.add('is-invalid');
                }
            }
        }

        // Clear validation errors
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }

        // ===============================================
        // VALIDATION FUNCTIONS
        // ===============================================
        
        // Validate current step
        function validateStep(step) {
            if (step === 0) {
                const userTypeInput = document.getElementById('id_user_type');
                if (!userTypeInput || !userTypeInput.value) {
                    showError('user_type', 'Please select whether you are a student or teacher');
                    return false;
                }
            }
            if (step === 1) {
                const requiredFields = ['first_name', 'last_name', 'school_email', 'password1', 'password2'];
                for (let field of requiredFields) {
                    const input = document.querySelector(`[name="${field}"]`);
                    if (!input || !input.value.trim()) {
                        showError(field, 'This field is required');
                        return false;
                    }
                }
                
                // Validate passwords match
                const password1 = document.querySelector('[name="password1"]').value;
                const password2 = document.querySelector('[name="password2"]').value;
                if (password1 !== password2) {
                    showError('password2', 'Passwords do not match');
                    return false;
                }
            }
            return true;
        }

        // ===============================================
        // COURSE SELECTOR FUNCTIONS (STEP 2)
        // ===============================================
        
        // Initialize course selectors for step 2 (help and experience)
        function initializeCourseSelectors() {
            console.log("Intializing course selectors");
            
            // Load saved selections if available
            const savedHelpCoursesStr = '{{ selected_help_courses|default:"[]"|safe|escapejs }}';
            const savedExperienceCoursesStr = '{{ selected_experience_courses|default:"[]"|safe|escapejs }}';
            const savedHelpCourses = savedHelpCoursesStr ? JSON.parse(savedHelpCoursesStr) : [];
            const savedExperienceCourses = savedExperienceCoursesStr ? JSON.parse(savedExperienceCoursesStr) : [];
            
            // Use current selections if available, otherwise use saved selections from server
            const helpCoursesToUse = currentHelpCourses.length > 0 ? currentHelpCourses : savedHelpCourses;
            const experienceCoursesToUse = currentExperienceCourses.length > 0 ? currentExperienceCourses : savedExperienceCourses;
            
            courseSelectors.help = new CourseSelector({
                containerId: 'helpCoursesSelector',
                initialSelection: helpCoursesToUse,
                formName: "onboardingForm",
                onSelectionChange: updateCourseValidation
            });

            courseSelectors.experience = new CourseSelector({
                containerId: 'experienceCoursesSelector',
                initialSelection: experienceCoursesToUse,
                formName: "onboardingForm",
                onSelectionChange: updateCourseValidation
            });
            
            // Initial validation check
            updateCourseValidation();
        }

        // Initialize schedule block course selectors for step 3
        function initializeScheduleSelectors() {
            console.log('Initializing schedule selectors');
            const savedScheduleDataStr = '{{ saved_schedule_data|default:"{}"|safe|escapejs }}';
            const savedScheduleData = savedScheduleDataStr ? JSON.parse(savedScheduleDataStr) : {};
            
            const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
            blocks.forEach(block => {
                const blockId = `block_${block}`;
                const containerId = `${blockId}_selector`;
                
                // Check if selector already exists
                if (courseSelectors[blockId]) {
                    console.log(`Selector for ${blockId} already exists`);
                    return;
                }
                
                // Check if container exists in DOM
                const container = document.getElementById(containerId);
                if (!container) {
                    console.log(`Container ${containerId} not found`);
                    return;
                }
                
                const savedCourse = savedScheduleData[block];
                const initialSelection = savedCourse && savedCourse.course_id ? 
                    [{ id: savedCourse.course_id, name: savedCourse.course }] : [];
                
                console.log(`Creating selector for ${blockId}`, initialSelection);
                
                courseSelectors[blockId] = new CourseSelector({
                    containerId: containerId,
                    initialSelection: initialSelection,
                    formName: "onboardingForm",
                    maxCourses: 1,
                    block: block
                });
            });
        }

        // Update course selection validation
        function updateCourseValidation() {
            const helpCount = courseSelectors.help ? courseSelectors.help.getSelectedCourses().length : 0;
            const experienceCount = courseSelectors.experience ? courseSelectors.experience.getSelectedCourses().length : 0;
            
            // Update counters
            const helpCountElement = document.getElementById('helpCoursesCount');
            const experienceCountElement = document.getElementById('experienceCoursesCount');
            const nextBtn2Continue = document.getElementById('nextBtn2Continue');
            
            if (helpCountElement) {
                helpCountElement.textContent = `${helpCount} courses selected (minimum 3)`;
                helpCountElement.className = helpCount >= 3 ? 'text-success' : 'text-muted';
            }
            
            if (experienceCountElement) {
                experienceCountElement.textContent = `${experienceCount} courses selected (minimum 3)`;
                experienceCountElement.className = experienceCount >= 3 ? 'text-success' : 'text-muted';
            }
            
            // Enable/disable next button based on requirements
            if (nextBtn2Continue) {
                const isValid = helpCount >= 3 && experienceCount >= 3;
                nextBtn2Continue.disabled = !isValid;
                
                if (isValid) {
                    nextBtn2Continue.classList.remove('btn-secondary');
                    nextBtn2Continue.classList.add('btn-primary');
                    nextBtn2Continue.innerHTML = 'Continue <i class="fas fa-arrow-right"></i>';
                } else {
                    nextBtn2Continue.classList.remove('btn-primary');
                    nextBtn2Continue.classList.add('btn-secondary');
                    const helpNeeded = Math.max(0, 3 - helpCount);
                    const expNeeded = Math.max(0, 3 - experienceCount);
                    if (helpNeeded > 0 && expNeeded > 0) {
                        nextBtn2Continue.innerHTML = `Select ${helpNeeded} more help courses and ${expNeeded} more experience courses`;
                    } else if (helpNeeded > 0) {
                        nextBtn2Continue.innerHTML = `Select ${helpNeeded} more help courses`;
                    } else if (expNeeded > 0) {
                        nextBtn2Continue.innerHTML = `Select ${expNeeded} more experience courses`;
                    }
                }
            }
        }

        // Save current course selections from step 3
        function saveCourseSelections() {
            if (courseSelectors.help && courseSelectors.help.getSelectedCourses) {
                currentHelpCourses = courseSelectors.help.getSelectedCourses();
            }
            if (courseSelectors.experience && courseSelectors.experience.getSelectedCourses) {
                currentExperienceCourses = courseSelectors.experience.getSelectedCourses();
            }
            console.log('Saved course selections:', {
                help: currentHelpCourses,
                experience: currentExperienceCourses
            });
        }

        // ===============================================
        // SCHEDULE FUNCTIONS (REMOVED - No longer needed)
        // ===============================================
        
        // Block buttons update function (similar to profile.html)
        window.updateBlockButtons = function(blockId, course, experiencedCourses, helpNeededCourses) {
            const buttonsContainer = document.getElementById(`${blockId}_buttons`);
            if (!buttonsContainer) return;
            
            if (course) {
                buttonsContainer.style.display = 'flex';
            } else {
                buttonsContainer.style.display = 'none';
            }
        };

        // ===============================================
        // NAVIGATION EVENT HANDLERS
        // ===============================================
        
        // Step 0 -> Step 1
        if (document.getElementById('nextBtn0')) {
            document.getElementById('nextBtn0').addEventListener('click', function() {
                clearErrors();
                if (validateStep(0)) {
                    currentStep = 1;
                    updateSteps();
                }
            });
        }
        
        // Step 1 -> Step 2
        if (document.getElementById('nextBtn1')) {
            document.getElementById('nextBtn1').addEventListener('click', function() {
                clearErrors();
                if (validateStep(1)) {
                    currentStep = 2;
                    updateSteps();
                }
            });
        }

        // Step 0 <- Step 1
        if (document.getElementById('prevBtn1')) {
            document.getElementById('prevBtn1').addEventListener('click', function() {
                currentStep = 0;
                updateSteps();
            });
        }

        // Step 1 <- Step 2
        if (document.getElementById('prevBtn2')) {
            document.getElementById('prevBtn2').addEventListener('click', function() {
                currentStep = 1;
                updateSteps();
            });
        }

        // Step 2 -> Step 3 (Schedule)
        if (document.getElementById('nextBtn2Continue')) {
            document.getElementById('nextBtn2Continue').addEventListener('click', function() {
                // Validate course selections
                const helpCount = courseSelectors.help ? courseSelectors.help.getSelectedCourses().length : 0;
                const experienceCount = courseSelectors.experience ? courseSelectors.experience.getSelectedCourses().length : 0;
                
                if (helpCount < 3 || experienceCount < 3) {
                    alert(`Please select at least 3 courses for each category. Currently: ${helpCount} help courses and ${experienceCount} experience courses selected.`);
                    return;
                }
                
                // Save current course selections before leaving step 2
                saveCourseSelections();
                
                // Initialize schedule selectors if not already done
                if (!courseSelectors.block_1A) {
                    initializeScheduleSelectors();
                }
                
                // Go to schedule step
                currentStep = 3;
                updateSteps();
            });
        }

        // Step 2 <- Step 3
        if (document.getElementById('prevBtn3')) {
            document.getElementById('prevBtn3').addEventListener('click', function() {
                currentStep = 2;
                updateSteps();
            });
        }

        // Step 3 -> Step 4 (Complete)
        if (document.getElementById('nextBtn3')) {
            document.getElementById('nextBtn3').addEventListener('click', function() {
                // Schedule is optional, so just proceed
                currentStep = 4;
                updateSteps();
            });
        }

        // Submit button handler
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                console.log('Submit button clicked');
                e.preventDefault(); 
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                this.disabled = true;
                
                try {
                    // Collect help and experience courses
                    if (courseSelectors.help && courseSelectors.help.getSelectedCourses) {
                        const helpCourses = courseSelectors.help.getSelectedCourses().map(course => course.id).join(',');
                        document.getElementById('help_courses_input').value = helpCourses;
                    }
                    
                    if (courseSelectors.experience && courseSelectors.experience.getSelectedCourses) {
                        const experienceCourses = courseSelectors.experience.getSelectedCourses().map(course => course.id).join(',');
                        document.getElementById('experience_courses_input').value = experienceCourses;
                    }
                    
                    // Collect all schedule data
                    const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
                    blocks.forEach(block => {
                        const blockId = `block_${block}`;
                        const selector = courseSelectors[blockId];
                        if (selector && selector.getSelectedCourses && selector.getSelectedCourses().length > 0) {
                            // Remove any existing input for this block to avoid duplicates
                            const existingInput = form.querySelector(`[name="${blockId}"]`);
                            if (existingInput) {
                                existingInput.remove();
                            }
                            
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = blockId;
                            hiddenInput.value = selector.getSelectedCourses()[0].id;
                            form.appendChild(hiddenInput);
                        }
                    });
                    
                    console.log('Form data collection complete, submitting form...');
                    
                    form.submit();
                    
                } catch (error) {
                    console.error('Error during form data collection:', error);
                    // Reset submit button on error
                    this.innerHTML = '<i class="fas fa-rocket"></i> Enter WolfKey';
                    this.disabled = false;
                }
            });
        } else {
            console.error('Submit button not found!');
        }

        // Initialize course selectors for step 2 on page load
        initializeCourseSelectors();
        
        updateSteps();
    });
</script>
{% endblock %}