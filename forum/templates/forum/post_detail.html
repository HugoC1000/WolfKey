{% extends 'forum/base.html' %}
{% load custom_filters %}
{% load static %}

<head>

    {% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'forum/css/carousel.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/files-display.css' %}">
    <link href="https://vjs.zencdn.net/8.16.1/video-js.css" rel="stylesheet" />
    {% endblock %}
</head>

{% block content %}
<!-- Post Details Section -->
<div class="card mb-4">
    <div class="card-body">
        <h1 class="card-title">{{ post.title }}</h1>
        <p class="text-muted">Posted by {{ post.author.username }} on {{ post.created_at|date:"F d, Y" }}</p>
        <p class="card-text">{{ post.content }}</p>
        <p>Tags: 
            {% for tag in post.tags.all %}
                <span class="badge badge-primary">{{ tag.name }}</span>
            {% endfor %}
        </p>
        <!-- Media Carousel Section -->
        {% with media_files=post.files.all|media_files %}
        {% if media_files %}
            <div class="carousel-wrapper">
                <div class="carousel-container">
                    {% for file in media_files %}
                        <div class="carousel-slide {% if forloop.first %}active{% endif %}">
                            <div class="aspect-ratio-box">
                                {% if file.file.url|lower|endswith:".jpg" or file.file.url|lower|endswith:".jpeg" or file.file.url|lower|endswith:".png" %}
                                    <img src="{{ file.file.url }}" alt="Image {{ forloop.counter }}">
                                {% elif file.file.url|lower|endswith:".mp4" or file.file.url|lower|endswith:".webm" or file.file.url|lower|endswith:".ogg" %}
                                    <div class="video-player">
                                        <video-js id="video-{{ forloop.counter }}" class="video-js vjs-default-skin" controls preload="auto" data-setup="{}">
                                            <source src="{{ file.file.url }}" type="video/{{ file.file.url|slice:"-3:" }}">
                                        </video-js>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-arrow prev">&#10094;</button>
                <button class="carousel-arrow next">&#10095;</button>
            </div>
        {% endif %}
        {% endwith %}

        <!-- Non-Image Files Section -->
        {% with non_media_files=post.files.all|exclude_media_files %}
            {% if non_media_files %}
                <div class="non-image-files mt-4">
                    <h3>Other Attached Files</h3>
                    <div class="file-grid">
                        {% for file in non_media_files %}
                            <div class="file-card">
                                <div class="file-icon {% if file.file.url|lower|endswith:'.pdf' %}pdf
                                    {% elif file.file.url|lower|endswith:'.doc' or file.file.url|lower|endswith:'.docx' %}word
                                    {% elif file.file.url|lower|endswith:'.xls' or file.file.url|lower|endswith:'.xlsx' %}excel
                                    {% elif file.file.url|lower|endswith:'.py' %}python
                                    {% elif file.file.url|lower|endswith:'.cpp' or file.file.url|lower|endswith:'.cxx' or file.file.url|lower|endswith:'.cc' %}cpp
                                    {% elif file.file.url|lower|endswith:'.html' %}html
                                    {% elif file.file.url|lower|endswith:'.css' %}css
                                    {% elif file.file.url|lower|endswith:'.java' %}java
                                    {% elif file.file.url|lower|endswith:'.js' %}javascript
                                    {% else %}default{% endif %}">
                                    {% if file.file.url|lower|endswith:".pdf" %}
                                        <i class="fas fa-file-pdf"></i>
                                    {% elif file.file.url|lower|endswith:".doc" or file.file.url|lower|endswith:".docx" %}
                                        <i class="fas fa-file-word"></i>
                                    {% elif file.file.url|lower|endswith:".xls" or file.file.url|lower|endswith:".xlsx" %}
                                        <i class="fas fa-file-excel"></i>
                                    {% else %}
                                        <i class="fas fa-file"></i>
                                    {% endif %}
                                </div>
                                <div class="file-name">{{ file.file.name|remove_upload}}</div>
                                <a href="{{ file.file.url }}" class="download-btn" download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}
    </div>
</div>




<!-- Add Solution Section -->
<h3>Add Solution</h3>
<form method="post" action="{% url 'post_detail' post.id %}">
    {% csrf_token %}
    <input type="hidden" name="action" value="create_solution">
    {{ solution_form.as_p }}
    <button type="submit" class="btn btn-primary">Submit Solution</button>
</form>

<!-- Solutions Section -->
<h3>Solutions</h3>
{% for solution in solutions %}
    <div class="card mb-2">
        <div class="card-body">
            <p>{{ solution.content }}</p>
            <small class="text-muted">Solution by {{ solution.author.username }} on {{ solution.created_at|date:"F d, Y" }}</small>
            <p>Upvotes: {{ solution.upvotes }}</p>
            <a href="{% url 'upvote_solution' solution.id %}" class="btn btn-sm btn-success">Upvote</a>
            {% if user.is_authenticated and user == solution.author %}
                <!-- Edit Solution Button -->
                <button class="btn btn-sm btn-warning" onclick="showEditSolutionForm('{{ solution.id }}');">Edit</button>
                <!-- Delete Solution Form -->
                <form method="post" action="{% url 'post_detail' post.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_solution">
                    <input type="hidden" name="solution_id" value="{{ solution.id }}">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
                <!-- Edit Solution Form -->
                <form method="post" action="{% url 'post_detail' post.id %}" class="edit-solution-form" id="edit-solution-form-{{ solution.id }}" style="display:none;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_solution">
                    <input type="hidden" name="solution_id" value="{{ solution.id }}">
                    {{ solution_form.as_p }}
                    <button type="submit" class="btn btn-sm btn-primary">Save</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="hideEditSolutionForm('{{ solution.id }}')">Cancel</button>
                </form>
            {% endif %}
            <!-- Comments Section for Each Solution -->
            <h5>Comments:</h5>
            {% for comment in solution.comments.all %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <p>{{ comment.content }}</p>
                    <small class="text-muted">Comment by {{ comment.author.username }} on {{ comment.created_at|date:"F d, Y" }}</small>
                    <p>Upvotes: {{ comment.upvotes }}</p>
                    <a href="{% url 'upvote_comment' comment.id %}" class="btn btn-sm btn-success">Upvote</a>
                    {% if user.is_authenticated and user == comment.author %}
                        <!-- Edit Comment Button -->
                        <button class="btn btn-sm btn-warning" onclick="showEditCommentForm('{{ comment.id }}');">Edit</button>
                        <!-- Delete Comment Form -->
                        <form method="post" action="{% url 'post_detail' post.id %}" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_comment">
                            <input type="hidden" name="comment_id" value="{{ comment.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                        <!-- Edit Comment Form -->
                        <form method="post" action="{% url 'post_detail' post.id %}" class="edit-comment-form" id="edit-comment-form-{{ comment.id }}" style="display:none;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="edit_comment">
                            <input type="hidden" name="comment_id" value="{{ comment.id }}">
                            {{ comment_form.as_p }}
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="hideEditCommentForm('{{ comment.id }}')">Cancel</button>
                        </form>
                    {% endif %}
                </div>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}
        </div>
    </div>
{% empty %}
    <p>No solutions yet.</p>
{% endfor %}
{% endblock %}


{% block scripts %}
<script src="https://vjs.zencdn.net/8.16.1/video.min.js"></script>
<script src="{% static 'forum/js/carousel.js' %}"></script>
{% endblock %}