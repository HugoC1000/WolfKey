{% extends 'forum/base.html' %}
{% load custom_filters %}
{% load static %}

<head>
    {% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'forum/css/carousel.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/files-display.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/editorjs.css' %}">
    <link href="https://vjs.zencdn.net/8.16.1/video-js.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    {% endblock %}
</head>

{% block content %}
    <div class="container py-4" id = "main-section">
        <!-- Question Header -->
        <div class="question-header">
            <h1>{{ post.title }}</h1>
            <div class="actions">
                <button class="button follow-button">
                    Follow<span class="follow-count">90</span>
                </button>
                <button class="button add-answer-button">Add answer</button>
            </div>
        </div>

        <!-- Question Content with Voting -->
        <div class="post-container">
            <!-- Post Content -->
            <div class="post-content-cell">
                <div id="editorjs"></div>
            </div>

            <!-- Tags -->
            <div class="mt-4">
                {% for tag in post.tags.all %}
                    <a href="#" class="tag">{{ tag.name }}</a>
                {% endfor %}
            </div>
                
           <!-- Author Card -->
            <div class="author-card">
                <div class="author-info">
                    <div class="author-avatar"></div>
                    <div>
                        <div class="text-muted">asked {{ post.created_at|date:"M d, Y" }}</div>
                        <div class="fw-bold">{{ post.author.username }}</div>
                    </div>
                </div>
            </div>
            <div class="post-actions">
                {% if user.is_authenticated and post.author == user %}
                    <a href="{% url 'edit_post' post.id %}" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    <hr>


    <!-- Solutions -->
    <h3 class="mt-4 mb-3">{{ solutions.count }} Solutions</h3>
    {% for solution in solutions %}
        <div class="solution-container">
            <!-- Solution Vote Cell -->
            <div class="vote-cell">
                <form method="post" action="{% url 'upvote_solution' solution.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="vote-button {% if user in solution.upvoters.all %}active{% endif %}">
                        <svg width="36" height="36" viewBox="0 0 36 36">
                            <path d="M2 26h32L18 10 2 26z"></path>
                        </svg>
                    </button>
                </form>
                
                <div class="vote-count">{{ solution|vote_difference }}</div>
                
                <form method="post" action="{% url 'downvote_solution' solution.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="vote-button {% if user in solution.downvoters.all %}active{% endif %}">
                        <svg width="36" height="36" viewBox="0 0 36 36">
                            <path d="M2 10h32L18 26 2 10z"></path>
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Solution Content -->
            <div class="post-content-cell">
                <div id="editorjs-solution-{{ solution.id }}"></div>
                
                <!-- Solution Author -->
                <div class="author-info mt-3">
                    <div class="author-avatar"></div>
                    <div>
                        <div>{{ solution.author.username }}</div>
                        <div class="text-muted">Answered {{ solution.created_at|date:"M d, Y" }}</div>
                    </div>
                </div>

                <!-- Solution Actions -->
                {% if user.is_authenticated %}
                <div class="solution-actions mt-3">
                    {% if user == solution.author %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="showEditSolutionForm('{{ solution.id }}')">Edit</button>
                        <form method="post" action="{% url 'post_detail' post.id %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_solution">
                            <input type="hidden" name="solution_id" value="{{ solution.id }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                        </form>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Comments -->
                <div class="comment-section mt-3">
                    {% for comment in solution.comments.all %}
                        <div class="comment mb-2">
                            <div class="comment-content">{{ comment.content }}</div>
                            <div class="small text-muted">
                                â€“ {{ comment.author.username }} {{ comment.created_at|date:"M d, Y" }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% empty %}
        <p>No solutions yet. Be the first to provide a solution!</p>
    {% endfor %}

        <!-- Add Solution Form -->
        {% if user.is_authenticated %}
        <div id = "solution-form-container" class="card mt-4">
            <div class="card-body">
                <h4>Your Solution</h4>
                <form method="post" action="{% url 'post_detail' post.id %}" id="solutionForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_solution">
                    <input type="hidden" id="solution-content" name="content">
                    <div id="editorjs-solution-form"></div>
                    <button type="submit" class="btn btn-primary mt-3">Post Your Solution</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    {% endblock %}

{% block scripts %}

<script defer src="//unpkg.com/mathlive"></script>
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css">



<!-- Initialize Editor.js -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.7.6/dist/quote.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@blade47/editorjs-delimiter@1.4.3/dist/delimiter.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@2"></script>
<script src="https://cdn.jsdelivr.net/gh/mdgaziur/EditorJS-LaTeX@latest/dist/editorjs-latex.bundle-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@calumk/editorjs-codecup@latest"></script>
<script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>

{% load static %}
<script src="{% static 'forum/js/inline-math.js' %}"></script>
<script src="{% static 'forum/js/editor-config.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            console.log("processed", '{{processed_solutions}}');
            // Initialize main post editor
            const content = JSON.parse('{{ content_json|escapejs }}');
            const editor = createEditor(
                'editorjs',
                content,
                '{{ csrf_token }}',
                true
            );

            // Initialize solution editors
            const processedSolutions = JSON.parse('{{ processed_solutions_json|escapejs }}');
            processedSolutions.forEach(solution => {
                try {
                    console.log(solution.content);
                    createEditor(
                        `editorjs-solution-${solution.id}`,
                        solution.content,
                        '{{ csrf_token }}',
                        true
                    );
                } catch (solutionError) {
                    console.error(`Error initializing solution ${solution.id}:`, solutionError);
                }
            });

            const solutionFormEditor = createEditor(
                'editorjs-solution-form',
                {},
                '{{ csrf_token }}',
                false,
                'solution-content'
            );

            const solutionForm = document.getElementById('solutionForm');
            if (solutionForm) {
                solutionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    try {
                        const outputData = await solutionFormEditor.save();
                        document.getElementById('solution-content').value = JSON.stringify(outputData);
                        this.submit();
                    } catch (error) {
                        console.error('Failed to save solution content:', error);
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing editors:', error);
        }
    });
</script>

{% endblock %}
