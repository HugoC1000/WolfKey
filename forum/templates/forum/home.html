{% extends 'forum/base.html' %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Welcome to Student Forum</h1>
        {% if user.is_authenticated %}
            <a href="{% url 'create_post' %}" class="btn btn-primary">Create Post</a>
        {% endif %}
    </div>

    <!-- Search Form -->
    <form method="get" action="{% url 'home' %}" class="mb-4" id="search-form">
        <div class="input-group mb-3">
            <input type="text" name="q" class="form-control" placeholder="Search posts..." id="search-input" value="">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="submit">Search</button>
            </div>
        </div>
        <div class="input-group mb-3">
            <div id="selected-tags" class="d-flex flex-wrap">
                <!-- Selected tags will appear here -->
            </div>
            <button type="button" class="btn btn-outline-secondary" id="toggle-tags">+</button>
        </div>
    </form>

    <!-- Floating Tag Selector -->
    <div id="tags-container" class="floating-tag-selector" style="display: none;">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Search tags..." id="tag-search-input">
        </div>
        <div class="input-group mb-3">
            <select name="tag" class="form-control" id="tag-select" multiple>
                {% for tag in tags %}
                    <option class = "tag-option" value="{{ tag.id }}">{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button class="btn btn-primary" id="add-tags">Add Tags</button>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="row"></div>

    <div class="row" id="post-list">
        {% for post in posts %}
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ post.title }}</h5>
                        <p class="card-text">{{ post.content|truncatewords:30 }}</p>
                        <a href="{% url 'post_detail' post.id %}" class="btn btn-primary">Read More</a>
                    </div>
                    <div class="card-footer text-muted">
                        Posted by {{ post.author.username }} on {{ post.created_at|date:"F d, Y" }}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <p>No posts found.</p>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const postList = document.getElementById('post-list');
    const toggleTagsButton = document.getElementById('toggle-tags');
    const tagsContainer = document.getElementById('tags-container');
    const tagSearchInput = document.getElementById('tag-search-input');
    const tagSelect = document.getElementById('tag-select');
    const selectedTagsContainer = document.getElementById('selected-tags');
    const addTagsButton = document.getElementById('add-tags');

    let selectedTags = [];

    toggleTagsButton.addEventListener('click', function() {
        if (tagsContainer.style.display === 'none') {
            const rect = toggleTagsButton.getBoundingClientRect();
            tagsContainer.style.top = `${rect.top - tagsContainer.offsetHeight + toggleTagsButton.offsetHeight + 10}px`; // Shift above the button
            tagsContainer.style.left = `${rect.left}px`; // Align with the button
            tagsContainer.style.display = 'block';
            toggleTagsButton.textContent = '-';
        } else {
            tagsContainer.style.display = 'none';
            toggleTagsButton.textContent = '+';
        }
    });

    tagSearchInput.addEventListener('input', function() {
        const filter = tagSearchInput.value.toLowerCase();
        const options = tagSelect.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            const text = option.text.toLowerCase();
            if (text.includes(filter)) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        }
    });

    addTagsButton.addEventListener('click', function() {
        const selectedOptions = Array.from(tagSelect.selectedOptions);
        selectedOptions.forEach(option => {
            if (!selectedTags.includes(option.value)) {
                selectedTags.push(option.value);
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = option.text;
                const removeButton = document.createElement('span');
                removeButton.textContent = ' x';
                removeButton.classList.add('remove-tag');
                removeButton.addEventListener('click', function() {
                    selectedTags = selectedTags.filter(tag => tag !== option.value);
                    tagDiv.remove();
                    updateSearch();
                });
                tagDiv.appendChild(removeButton);
                selectedTagsContainer.appendChild(tagDiv);
            }
        });
        tagsContainer.style.display = 'none';
        toggleTagsButton.textContent = '+';
        updateSearch();
    });

    function updateSearch() {
        const query = searchInput.value;
        const tags = selectedTags.join(',');

        fetch(`/search/?q=${encodeURIComponent(query)}&tags=${encodeURIComponent(tags)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                searchResults.innerHTML = '';
                postList.style.display = 'none';

                data.results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.classList.add('col-md-6', 'mb-4');
                    resultDiv.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${result.title}</h5>
                                <p class="card-text">${result.content}</p>
                                <a href="${result.url}" class="btn btn-primary">Read More</a>
                            </div>
                        </div>
                    `;
                    searchResults.appendChild(resultDiv);
                });
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
    }

    searchInput.addEventListener('input', updateSearch);
});
</script>
{% endblock %}