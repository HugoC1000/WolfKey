<!DOCTYPE html>
<html lang="en"></html>
<head>
    <meta charset="UTF-8">
    <title>Student Forum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- FilePond -->
    <link href="https://cdn.jsdelivr.net/npm/filepond@4.30.2/dist/filepond.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/filepond-plugin-image-edit/dist/filepond-plugin-image-edit.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/filepond@4.30.2/dist/filepond.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/filepond-plugin-image-edit/dist/filepond-plugin-image-edit.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
    <script src="https://unpkg.com/filepond/dist/filepond.js"></script>


    {% block head %}
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        {% load static %}
        <link rel="stylesheet" href="{% static 'forum/css/styles.css' %}">
    {% endblock %}

    
</head>
<body>

    {% block scripts %}{% endblock %}

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container" id = "nav-container">
                <a class="navbar-brand" href="{% url 'home' %}">Student Forum</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
                    <div class="search-container">
                        <form method="get" action="{% url 'search_results_new_page' %}" class="d-flex align-items-center" id="search-form">
                            <button class="btn btn-primary d-flex align-items-center me-2" type="submit" id="search-button">
                                <i class="bi bi-search"></i>
                            </button>
                            <input type="text" 
                                name="q" 
                                class="form-control" 
                                placeholder="Search posts..." 
                                id="search-input" 
                                value="{{ query }}"
                                onkeypress="if(event.keyCode==13) { this.form.submit(); return false; }">
                            <input type="hidden" name="tags" id="selected-tags-input" value="{{ selected_tags|join:',' }}">
                            <button type="button" class="btn btn-outline-secondary" id="toggle-tags">+</button>
                        </form>
                        
                        <div id="selected-tags" class="selected-tags-container">
                            <!-- Selected tags will appear here -->
                        </div>
                    </div>
                    

                    <ul class="navbar-nav">
                        {% if user.is_authenticated %}
                            <li class="nav-item"><a href="{% url 'create_post' %}" class="nav-link px-2" title="Create Post"><i class="bi bi-plus-square"></i></a></li>
                            {% if user.is_moderator or user.is_superuser %}
                                <li class="nav-item"><a href="{% url 'admin:index' %}" class="nav-link px-2" title="Admin Panel"><i class="bi bi-gear"></i></a></li>
                            {% endif %}
                            <li class="nav-item"><a href="{% url 'profile' user.username %}" class="nav-link px-2" title="Profile"><i class="bi bi-person"></i></a></li>
                            <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link px-2" title="Logout"><i class="bi bi-box-arrow-right"></i></a></li>
                        {% else %}
                            <li class="nav-item"><a href="{% url 'login' %}" class="nav-link px-2" title="Login"><i class="bi bi-box-arrow-in-right"></i></a></li>
                            <li class="nav-item"><a href="{% url 'register' %}" class="nav-link px-2" title="Register"><i class="bi bi-person-plus"></i></a></li>
                        {% endif %}
                    </ul>
    
                    </div>
                    <!-- Floating Tag Selector -->
                    <div id="tags-container" class="floating-tag-selector">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Search tags..." id="tag-search-input">
                        </div>
                        <div class="input-group mb-3 custom-select-container">
                            <div class="custom-select" id="custom-tag-select">
                                {% for tag in tags %}
                                    <div class="custom-select-option" data-value="{{ tag.id }}">{{ tag.name }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <button class="btn btn-primary" id="add-tags">Add Tags</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <nav class="sidebar">
            <ul class="list-unstyled">
                <li><a href="{% url 'home' %}"><i class="bi bi-house"></i> Home</a></li>
                <li><a href="{% url 'saved_posts' %}"><i class="bi bi-bookmark"></i> Saved</a></li>
                <li><a href="{% url 'my_posts'%}"><i class="bi bi-bookmark"></i> My Posts</a></li>
            </ul>
        </nav>

        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>

        <div id="content">
            <div class="main-content">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                
                {% block content %}
                {% endblock %}
            </div>
        </div>

    <!-- Floating Tag Selector -->
    <div id="tags-container" class="floating-tag-selector">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Search tags..." id="tag-search-input">
        </div>
        <div class="input-group mb-3 custom-select-container">
            <div class="custom-select" id="custom-tag-select">
                {% for tag in tags %}
                    <div class="custom-select-option" data-value="{{ tag.id }}">{{ tag.name }}</div>
                {% endfor %}
            </div>
        </div>
        <button class="btn btn-primary" id="add-tags">Add Tags</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqV</li>gRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" c""rossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4xF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    {% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('search-form');
        const searchResults = document.getElementById('search-results');
        const postList = document.getElementById('post-list');
        const toggleTagsButton = document.getElementById('toggle-tags');
        const tagsContainer = document.getElementById('tags-container');
        const tagSearchInput = document.getElementById('tag-search-input');
        const customTagSelect = document.getElementById('custom-tag-select');
        const selectedTagsContainer = document.getElementById('selected-tags');
        const addTagsButton = document.getElementById('add-tags');
        const selectedTagsInput = document.getElementById('selected-tags-input');

        let selectedTags = [];

        toggleTagsButton.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent the click from propagating to the document
            if (tagsContainer.style.display === 'none') {
                const rect = toggleTagsButton.getBoundingClientRect();
                tagsContainer.style.top = `${rect.bottom + window.scrollY}px`; // Position below the button
                tagsContainer.style.left = `${rect.left + window.scrollX}px`; // Align with the button
                tagsContainer.style.display = 'block';
                toggleTagsButton.textContent = '-';
            } else {
                tagsContainer.style.display = 'none';
                toggleTagsButton.textContent = '+';
            }
        });

        document.addEventListener('click', function(event) {
            if (!tagsContainer.contains(event.target) && event.target !== toggleTagsButton) {
                tagsContainer.style.display = 'none';
                toggleTagsButton.textContent = '+';
            }
        });

        tagSearchInput.addEventListener('input', function() {
            const filter = tagSearchInput.value.toLowerCase();
            const options = customTagSelect.children;
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const text = option.textContent.toLowerCase();
                if (text.includes(filter)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            }
        });

        customTagSelect.addEventListener('click', function(event) {
            const option = event.target;
            if (option.classList.contains('custom-select-option')) {
                option.classList.toggle('selected');
            }
        });

        addTagsButton.addEventListener('click', function() {
            const selectedOptions = Array.from(customTagSelect.getElementsByClassName('selected'));
            selectedTags = selectedOptions.map(option => option.getAttribute('data-value'));
            selectedTagsInput.value = selectedTags.join(',');
            selectedTagsContainer.innerHTML = ''; // Clear existing tags
            selectedOptions.forEach(option => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = option.textContent;
                const removeButton = document.createElement('span');
                removeButton.textContent = ' x';
                removeButton.classList.add('remove-tag');
                removeButton.addEventListener('click', function() {
                    selectedTags = selectedTags.filter(tag => tag !== option.getAttribute('data-value'));
                    selectedTagsInput.value = selectedTags.join(',');
                    tagDiv.remove();
                    updateSearch();
                });
                tagDiv.appendChild(removeButton);
                selectedTagsContainer.appendChild(tagDiv);
            });
            tagsContainer.style.display = 'none';
            toggleTagsButton.textContent = '+';
            updateSearch();
        });

        function updateSearch() {
            const query = searchInput.value;
            const tags = selectedTags.join(',');

            if(query.includes(' ') || query == ''){


                fetch(`/search/?q=${encodeURIComponent(query)}&tags=${encodeURIComponent(tags)}`)
                    .then(response => response.text())
                    .then(text => {
                        try {
                            // console.log(text);
                            const data = JSON.parse(text);
                            console.log(text);
                            searchResults.innerHTML = '';
                            postList.style.display = 'none';

                            if (data.results.length === 0) {
                                searchResults.innerHTML = '<p>No posts found.</p>';
                            } else {
                                data.results.forEach(result => {
                                const resultDiv = document.createElement('div');
                                resultDiv.classList.add('col-md-6', 'mb-4');

                                // Format the created_at date using JavaScript
                                const createdAt = new Date(result.created_at);
                                const formattedDate = createdAt.toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                });

                                resultDiv.innerHTML = `
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">${result.title}</h5>
                                            <p class="card-text">${result.content}</p>
                                            <a href="${result.url}" class="btn btn-primary">Read More</a>
                                        </div>
                                    </div>
                                    <div class="card-footer text-muted">
                                        Posted by ${result.author} on ${formattedDate}
                                        </div>
                                `;
                                searchResults.appendChild(resultDiv);
                            });

                            }
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                            console.log('Response text:', text); // Log the response text
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        response.text().then(text => console.log('Response text:', text)); // Log the response text
                    });
            }
        }

        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const searchInput = document.getElementById('search-input');
            console.log("Submitting…");
            if (searchInput.value.trim()) {
                this.submit();
            }
        });

        searchInput.addEventListener('input', updateSearch);

    });
    </script>
    {% endblock %}
</body>
</html>