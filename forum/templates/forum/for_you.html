{% extends 'forum/base.html' %}

{% block head %}
{%load static %}
    <link rel="stylesheet" href="{% static 'forum/css/schedule.css' %}"> 
    <link rel="stylesheet" href="{% static 'forum/css/post-card.css' %}">
    <script src="{% static 'forum/js/schedule.js' %}" defer></script>
{% endblock %}
{% block content %}
    <div class="d-flex justify-content-center align-items-center mb-2">
        <h1 class="fade-text" id="animated-text" style = "display: none;">{{ greeting }}</h1>
    </div>

    <!-- Schedule-->
    <div class="row" style = "margin-bottom: 3rem;">
        <div class="col-md-8">
            <div class="d-flex flex-wrap gap-4">
                <!-- Today's Schedule -->
                <div class="flex-fill">
                    <div class = "card">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h3 style = "font-size: 1.5rem;">Today's Schedule</h3>
                            <span class="text-muted" id="current-date">
                                {{ current_date}}
                            </span>
                        </div>
                        <div class="d-flex gap-2 mb-2 justify-content-end flex-wrap">
                            {% if ceremonial_required_today %}
                            <span class="badge rounded-pill schedule-badge-ceremonial">
                                <i class="fas fa-user-tie me-1"></i>Ceremonial Uniform
                            </span>
                            {% endif %}
                            {% if early_dismissal_today %}
                            <span class="badge rounded-pill schedule-badge-early">
                                <i class="fas fa-clock me-1"></i>Early Dismissal
                            </span>
                            {% endif %}
                            {% if late_start_today %}
                            <span class="badge rounded-pill schedule-badge-late">
                                <i class="fas fa-coffee me-1"></i>Late Start
                            </span>
                            {% endif %}
                        </div>
                        <ul class="list-group shadow-sm rounded"id = "today-schedule">
                            {% if schedule_today %}
                                {% for item in schedule_today %}
                                {% if item == "no school"  %}
                                <li class="list-group-item">
                                    <p style = "margin-bottom: 0px;">No School</p>
                                </li>
                                {% else %}
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <p style = "margin-bottom: 0px;">{{ item.block }}</p>
                                            {% if item.time %}
                                                <p style = "margin-bottom: 0px;">{{ item.time }} </p>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endif %}
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item">
                                    <p style = "margin-bottom: 0px;">Schedule unavailable</p>
                                </li>
                            {% endif %}
                        </ul>
                    </div>

                </div>
    
                <!-- Tomorrow's Schedule -->
                <div class="flex-fill">
                    <div class = "card">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h3 style = "font-size: 1.5rem;" id="schedule-title">{{ schedule_title }}</h3>
                        <div class="d-flex align-items-center gap-2">
                            <button id="prev-day" class="btn btn-sm btn-outline-secondary" title="Previous day">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <input type="date" id="schedule-date-picker" class="form-control form-control-sm" style="max-width: 150px;" value="{{ tomorrow_iso }}" data-tomorrow="{{ tomorrow_iso }}">
                            <button id="next-day" class="btn btn-sm btn-outline-secondary" title="Next day">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-2 justify-content-end flex-wrap" id="schedule-badges">
                        {% if ceremonial_required_tomorrow %}
                        <span class="badge rounded-pill schedule-badge-ceremonial">
                            <i class="fas fa-user-tie me-1"></i>Ceremonial Uniform
                        </span>
                        {% endif %}
                        {% if early_dismissal_tomorrow %}
                        <span class="badge rounded-pill schedule-badge-early">
                            <i class="fas fa-clock me-1"></i>Early Dismissal
                        </span>
                        {% endif %}
                        {% if late_start_tomorrow %}
                        <span class="badge rounded-pill schedule-badge-late">
                            <i class="fas fa-coffee me-1"></i>Late Start
                        </span>
                        {% endif %}
                    </div>
                    <ul class="list-group shadow-sm rounded" id = "tomorrow-schedule">
                        {% if schedule_tomorrow %}
                            {% for item in schedule_tomorrow %}
                            {% if item == "no school"  %}
                            <li class="list-group-item">
                                <p style = "margin-bottom: 0px;">No School</p>
                            </li>
                            {% else %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <p style = "margin-bottom: 0px;">{{ item.block }}</p>
                                    {% if item.time %}
                                        <p style = "margin-bottom: 0px;">{{ item.time }} </p>
                                    {% endif %}
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item">
                                <p style = "margin-bottom: 0px;">Schedule unavailable</p>
                            </li>
                        {% endif %}
                    </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Leaderboard -->
        <div class="col-md-4 d-none d-md-block">
            <!-- Reserved space -->
        </div>
    </div>

    <!-- Display the posts -->
    <div class="row" id="post-list">
        {% include 'forum/components/post_list.html' %}
    </div>

   <div id="loading-spinner" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="text-center mt-4">
        <div class = "card" style ="margin: auto; max-width: 776px;">
            <p> You've reached the end. </p>
            <a href="{% url 'all_posts' %}" class="btn btn-primary">
                <i class="fas fa-search me-2"></i> Explore
            </a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Create animation observer function to reuse for new posts
        function createAnimationObserver() {
            return new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.02
            });
        }

        // Initialize animation observer
        const animationObserver = createAnimationObserver();

        // Observe initial posts
        const postCards = document.querySelectorAll('[data-animate]');
        postCards.forEach(card => animationObserver.observe(card));

        // Text animation code
        const textElement = document.getElementById('animated-text');
        const text = textElement.textContent;
        textElement.textContent = '';
        textElement.style.display = "block";
        
        // Split text into individual characters
        for (let i = 0; i < text.length; i++) {
            const span = document.createElement('span');
            if (text[i] === ' ') {
                span.innerHTML = '&nbsp;';
            } else {
                span.textContent = text[i];
            }
            span.style.animationDelay = (i * 60) + 'ms'; // Adjust timing
            textElement.appendChild(span);
        }

        // Infinite scroll
        let page = 1;
        let loading = false;
        let hasMore = true;
        const postList = document.getElementById('post-list');
        const loadingSpinner = document.getElementById('loading-spinner');

        function loadMorePosts() {
            if (loading || !hasMore) return;
            
            loading = true;
            loadingSpinner.classList.remove('d-none');
            
            page++;
            fetch(`${window.location.pathname}?page=${page}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                if (html.trim()) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newPosts = doc.querySelectorAll('.post-card-container');
                    
                    if (newPosts.length === 0) {
                        hasMore = false;
                        loadingSpinner.style.display = 'none';
                        return;
                    }

                    newPosts.forEach(post => {
                        postList.appendChild(post);
                        if (post.hasAttribute('data-animate')) {
                            animationObserver.observe(post);
                        }
                    });
                    
                    checkForScrollTarget();
                } else {
                    hasMore = false;
                    loadingSpinner.style.display = 'none';
                }
                loading = false;
            })
            .catch(error => {
                console.error('Error loading posts:', error);
                loading = false;
                loadingSpinner.classList.add('d-none');
            });
        }

        // Intersection Observer for infinite scroll
        const scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !loading && hasMore) {
                loadMorePosts();
            }
        }, {
            root: null,
            rootMargin: '1000px',
            threshold: 0.1
        });

        if (loadingSpinner) {
            scrollObserver.observe(loadingSpinner);
        }
        
        // Check if we need to scroll to a specific post
        function checkForScrollTarget() {
            const targetPostId = sessionStorage.getItem('scrollToPostId');
            if (targetPostId) {
                const postCard = document.querySelector(`[data-post-url*="post/${targetPostId}/"]`);
                if (postCard) {
                    sessionStorage.removeItem('scrollToPostId'); // Remove after use
                    
                    // Add a highlight effect
                    postCard.style.transition = 'box-shadow 0.3s ease';
                    postCard.style.boxShadow = '0 0 0 3px rgba(66, 153, 225, 0.5)';
                    
                    // Scroll to the post with some offset
                    postCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Remove highlight after a delay
                    setTimeout(() => {
                        postCard.style.boxShadow = '';
                    }, 2000);
                    
                    return true;
                }
            }
            return false;
        }
        
        function scrollToPostIfNeeded() {
            const targetPostId = sessionStorage.getItem('scrollToPostId');
            if (targetPostId) {
                // Try to scroll immediately
                if (!checkForScrollTarget()) {
                    // If post not found, automatically load more posts until we find it
                    let attempts = 0;
                    const maxAttempts = 40;
                    
                    const findPostInterval = setInterval(() => {
                        attempts++;
                        
                        // Check if post is now available
                        if (checkForScrollTarget()) {
                            clearInterval(findPostInterval);
                            return;
                        }
                        
                        // If we still have more posts to load and haven't exceeded attempts
                        if (hasMore && !loading && attempts < maxAttempts) {
                            console.log(`Attempting to load more posts to find post ${targetPostId} (attempt ${attempts})`);
                            loadMorePosts();
                        } else if (attempts >= maxAttempts || !hasMore) {
                            clearInterval(findPostInterval);
                            sessionStorage.removeItem('scrollToPostId');
                            console.log(`Could not find post ${targetPostId} after ${attempts} attempts`);
                        }
                    }, 200);
                }
            }
        }
        

        setTimeout(scrollToPostIfNeeded, 100);
    });
</script>
{% endblock %}